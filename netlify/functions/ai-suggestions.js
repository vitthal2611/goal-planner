const fetch = require('node-fetch');\n\nexports.handler = async (event, context) => {\n  if (event.httpMethod !== 'POST') {\n    return {\n      statusCode: 405,\n      body: JSON.stringify({ error: 'Method not allowed' })\n    };\n  }\n\n  const { prompt, type } = JSON.parse(event.body);\n\n  try {\n    const response = await fetch('https://api.openai.com/v1/chat/completions', {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`\n      },\n      body: JSON.stringify({\n        model: 'gpt-3.5-turbo',\n        messages: [{\n          role: 'user',\n          content: `${prompt}\\n\\nReturn only a JSON array of 3 suggestions in this format:\\n${getFormatExample(type)}`\n        }],\n        max_tokens: 300,\n        temperature: 0.7\n      })\n    });\n\n    if (!response.ok) {\n      throw new Error(`OpenAI API error: ${response.status}`);\n    }\n\n    const data = await response.json();\n    const suggestions = JSON.parse(data.choices[0].message.content);\n\n    return {\n      statusCode: 200,\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({ suggestions })\n    };\n  } catch (error) {\n    console.error('AI service error:', error);\n    \n    const fallbackSuggestions = getFallbackSuggestions(type);\n    return {\n      statusCode: 200,\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({ suggestions: fallbackSuggestions })\n    };\n  }\n};\n\nfunction getFormatExample(type) {\n  if (type === 'goal') {\n    return '[{\"title\": \"Read 24 books\", \"target\": 24, \"unit\": \"books\"}]';\n  } else if (type === 'habit') {\n    return '[{\"name\": \"Read for 30 minutes\", \"trigger\": \"After morning coffee\", \"time\": \"08:00\", \"location\": \"Living room\"}]';\n  } else if (type === 'trigger') {\n    return '[{\"trigger\": \"After morning coffee\"}]';\n  }\n}\n\nfunction getFallbackSuggestions(type) {\n  if (type === 'goal') {\n    return [\n      { title: 'Achieve personal growth', target: 12, unit: 'milestones' },\n      { title: 'Build healthy habits', target: 365, unit: 'days' },\n      { title: 'Improve skills', target: 100, unit: 'hours' }\n    ];\n  } else if (type === 'habit') {\n    return [\n      { name: 'Daily practice', trigger: 'After breakfast', time: '08:30', location: 'Home' },\n      { name: 'Evening routine', trigger: 'Before bed', time: '21:00', location: 'Bedroom' },\n      { name: 'Morning activity', trigger: 'After waking up', time: '07:00', location: 'Living room' }\n    ];\n  } else if (type === 'trigger') {\n    return [\n      { trigger: 'After morning coffee' },\n      { trigger: 'Before breakfast' },\n      { trigger: 'After work' }\n    ];\n  }\n  return [];\n}